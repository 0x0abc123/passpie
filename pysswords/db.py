import os
import gnupg
import shutil
import yaml


def keys_path(path):
    return os.path.join(path, ".keys")


def getgpg(path):
    return gnupg.GPG(binary=shutil.which("gpg"), homedir=keys_path(path))


def pyssword_content(name, login, password, comment):
    credential = {
        "name": name,
        "login": login,
        "password": password,
        "comment": comment
    }
    return yaml.dump(credential)


def key_input(path, passphrase):
    return getgpg(path).gen_key_input(
        name_real="Pysswords",
        name_email="pysswords@pysswords",
        name_comment="Auto-generated by Pysswords",
        key_length=4096,
        expire_date=0,
        passphrase=passphrase
    )


def create_keys(path, passphrase):
    key = getgpg.gen_key(key_input(path, passphrase))
    return key


def create_keyring(path, passphrase):
    create_keys(keys_path(path), passphrase)
    return keys_path


def create_credential(path, name, login, password, comment):
    credential_dir = os.path.join(path, name)
    os.makedirs(credential_dir)
    credential_file = "{}.pyssword".format(login)
    with open(os.path.join(credential_dir, credential_file), "w") as f:
        credential = {
            "name": name,
            "login": login,
            "password": password,
            "comment": comment
        }
        f.write(pyssword_content(**credential))


def create(path):
    os.makedirs(path)
